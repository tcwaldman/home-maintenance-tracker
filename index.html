<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HomeCare">
<title>HomeCare ‚Äî Maintenance Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,300&family=Fraunces:opsz,wght@9..144,600;9..144,800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #111113;
  --surface: #1c1c20;
  --surface2: #26262b;
  --surface3: #303036;
  --border: #38383f;
  --text: #ededeb;
  --text2: #8e8e8a;
  --text3: #5c5c58;
  --accent: #56c4b8;
  --accent-bright: #6ff0e1;
  --accent-dim: rgba(86,196,184,0.10);
  --accent-dim2: rgba(86,196,184,0.06);
  --warning: #e8a44a;
  --warning-dim: rgba(232,164,74,0.10);
  --danger: #d4553e;
  --danger-dim: rgba(212,85,62,0.10);
  --success: #5db86a;
  --success-dim: rgba(93,184,106,0.10);
  --radius: 14px;
  font-size: 16px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body {
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh; min-height:100dvh;
  overflow-x:hidden;
  padding-bottom:110px;
}
h1,h2,h3,.brand{font-family:'Fraunces',serif;}

/* ===== SETUP SCREEN ===== */
.setup-screen {
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  min-height:100vh; min-height:100dvh;
  padding:40px 28px;
  text-align:center;
}
.setup-screen .brand { font-size:2.2rem; font-weight:800; color:var(--accent); margin-bottom:6px; }
.setup-screen .sub { color:var(--text2); font-size:0.9rem; margin-bottom:40px; }
.setup-box {
  width:100%; max-width:340px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:18px;
  padding:28px 24px;
  margin-bottom:16px;
}
.setup-box h3 { font-size:1rem; margin-bottom:6px; color:var(--text); }
.setup-box p { font-size:0.82rem; color:var(--text2); margin-bottom:16px; line-height:1.4; }
.setup-input {
  width:100%; padding:14px 16px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:10px; color:var(--text);
  font-family:'DM Sans',sans-serif; font-size:1.05rem;
  outline:none; text-align:center;
  letter-spacing:3px; font-weight:700;
  text-transform:uppercase;
  margin-bottom:12px;
  transition:border 0.2s;
}
.setup-input:focus { border-color:var(--accent); }
.setup-input::placeholder { letter-spacing:1px; font-weight:400; text-transform:none; color:var(--text3); }
.setup-btn {
  width:100%; padding:14px;
  border-radius:10px; border:none;
  background:var(--accent); color:var(--bg);
  font-family:'DM Sans',sans-serif;
  font-size:0.95rem; font-weight:700;
  cursor:pointer; transition:all 0.15s;
}
.setup-btn:active { transform:scale(0.96); }
.setup-btn.secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); margin-top:8px; }
.setup-divider {
  color:var(--text3); font-size:0.8rem;
  margin:8px 0; padding:4px 0;
}
.setup-error { color:var(--danger); font-size:0.82rem; margin-top:8px; min-height:1.2em; }

/* ===== HEADER ===== */
.header {
  position:sticky; top:0; z-index:100;
  background:rgba(17,17,19,0.88);
  backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
  padding:14px 18px 10px;
  border-bottom:1px solid var(--border);
}
.header-top { display:flex; justify-content:space-between; align-items:center; }
.brand { font-size:1.35rem; font-weight:800; color:var(--accent); letter-spacing:-0.5px; }
.brand .household-code {
  font-family:'DM Sans',sans-serif;
  font-size:0.65rem; font-weight:600;
  color:var(--text3); letter-spacing:2px;
  margin-left:8px; vertical-align:middle;
  background:var(--surface2); padding:2px 8px;
  border-radius:6px;
}
.header-actions { display:flex; gap:7px; }
.icon-btn {
  background:var(--surface);
  border:1px solid var(--border);
  color:var(--text2);
  width:36px; height:36px;
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:1rem;
  transition:all 0.2s;
}
.icon-btn:active { transform:scale(0.9); background:var(--surface2); }
.icon-btn.active { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); }

/* Stats */
.stats-bar {
  display:flex; gap:7px; margin-top:12px;
  overflow-x:auto; scrollbar-width:none;
}
.stats-bar::-webkit-scrollbar{display:none;}
.stat-pill {
  flex-shrink:0; padding:5px 12px; border-radius:18px;
  font-size:0.75rem; font-weight:600;
  letter-spacing:0.3px;
  display:flex; align-items:center; gap:5px;
}
.stat-pill .dot { width:7px; height:7px; border-radius:50%; }
.stat-overdue { background:var(--danger-dim); color:var(--danger); }
.stat-overdue .dot { background:var(--danger); }
.stat-due { background:var(--warning-dim); color:var(--warning); }
.stat-due .dot { background:var(--warning); }
.stat-good { background:var(--success-dim); color:var(--success); }
.stat-good .dot { background:var(--success); }

/* ===== VIEW TABS (List / Calendar) ===== */
.view-tabs {
  display:flex; padding:12px 18px 0; gap:0;
}
.view-tab {
  flex:1; padding:9px; text-align:center;
  font-size:0.82rem; font-weight:600;
  color:var(--text3);
  border-bottom:2px solid transparent;
  cursor:pointer; transition:all 0.2s;
  background:none; border-top:none; border-left:none; border-right:none;
  font-family:'DM Sans',sans-serif;
}
.view-tab.active { color:var(--accent); border-bottom-color:var(--accent); }

/* ===== FILTER TABS ===== */
.filter-tabs {
  display:flex; gap:6px; padding:12px 18px 4px;
  overflow-x:auto; scrollbar-width:none;
}
.filter-tabs::-webkit-scrollbar{display:none;}
.tab {
  flex-shrink:0; padding:6px 14px;
  border-radius:18px; font-size:0.78rem; font-weight:500;
  background:var(--surface); color:var(--text2);
  border:1px solid var(--border);
  cursor:pointer; transition:all 0.2s;
}
.tab.active { background:var(--accent); color:var(--bg); border-color:var(--accent); font-weight:700; }

/* ===== CALENDAR VIEW ===== */
.cal-controls {
  display:flex; gap:6px; padding:8px 18px;
  overflow-x:auto; scrollbar-width:none;
}
.cal-controls::-webkit-scrollbar{display:none;}
.cal-range-btn {
  flex-shrink:0; padding:6px 14px;
  border-radius:18px; font-size:0.78rem; font-weight:500;
  background:var(--surface); color:var(--text2);
  border:1px solid var(--border);
  cursor:pointer; transition:all 0.2s;
  font-family:'DM Sans',sans-serif;
}
.cal-range-btn.active { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); }

.cal-section { padding:6px 18px; }
.cal-day-header {
  font-family:'Fraunces',serif;
  font-size:0.88rem; font-weight:600;
  color:var(--text2); padding:14px 2px 6px;
  display:flex; justify-content:space-between; align-items:baseline;
}
.cal-day-header .day-label { color:var(--text); }
.cal-day-header .day-sub { font-family:'DM Sans',sans-serif; font-size:0.72rem; color:var(--text3); }
.cal-day-header.today .day-label { color:var(--accent-bright); }

.cal-task {
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; margin-bottom:6px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; cursor:pointer;
  transition:all 0.15s;
  position:relative;
}
.cal-task:active { transform:scale(0.98); }
.cal-task-dot {
  width:8px; height:8px; border-radius:50%; flex-shrink:0;
}
.cal-task-dot.overdue { background:var(--danger); }
.cal-task-dot.due-soon { background:var(--warning); }
.cal-task-dot.good { background:var(--success); }
.cal-task-name { flex:1; font-size:0.88rem; font-weight:500; }
.cal-task-cat { font-size:0.72rem; color:var(--text3); }
.cal-task-action {
  background:var(--accent); color:var(--bg);
  border:none; border-radius:8px;
  padding:6px 12px; font-size:0.75rem; font-weight:700;
  font-family:'DM Sans',sans-serif;
  cursor:pointer; flex-shrink:0;
}
.cal-task-action:active { transform:scale(0.9); }

.cal-empty {
  text-align:center; padding:30px 20px;
  color:var(--text3); font-size:0.85rem;
}

/* ===== TASK LIST ===== */
.task-list { padding:8px 16px; }
.task-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:13px 15px;
  margin-bottom:9px; transition:all 0.2s;
  cursor:pointer; position:relative; overflow:hidden;
  animation:fadeIn 0.25s ease-out;
}
.task-card:active { transform:scale(0.98); }
.task-card::before {
  content:''; position:absolute;
  left:0; top:0; bottom:0; width:4px;
}
.task-card.overdue::before { background:var(--danger); }
.task-card.due-soon::before { background:var(--warning); }
.task-card.good::before { background:var(--success); }

.task-top { display:flex; justify-content:space-between; align-items:flex-start; }
.task-name { font-weight:700; font-size:0.92rem; flex:1; padding-right:8px; }
.task-badge {
  font-size:0.67rem; font-weight:700;
  padding:3px 8px; border-radius:7px;
  text-transform:uppercase; letter-spacing:0.4px; flex-shrink:0;
}
.badge-overdue { background:var(--danger-dim); color:var(--danger); }
.badge-due { background:var(--warning-dim); color:var(--warning); }
.badge-good { background:var(--success-dim); color:var(--success); }

.task-meta {
  margin-top:7px; font-size:0.78rem; color:var(--text2);
  display:flex; flex-wrap:wrap; gap:10px;
}
.task-meta span { display:flex; align-items:center; gap:4px; }

.task-actions { display:flex; gap:7px; margin-top:11px; }
.action-btn {
  flex:1; padding:9px; border-radius:10px;
  border:1px solid var(--border);
  background:var(--surface2); color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:0.8rem; font-weight:600;
  cursor:pointer; transition:all 0.15s; text-align:center;
}
.action-btn:active { transform:scale(0.95); }
.action-btn.primary { background:var(--accent); color:var(--bg); border-color:var(--accent); }

/* ===== FAB ===== */
.fab {
  position:fixed; bottom:26px; right:18px;
  width:56px; height:56px; border-radius:50%;
  background:var(--accent); color:var(--bg);
  border:none; font-size:1.7rem;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 24px rgba(86,196,184,0.35);
  cursor:pointer; z-index:90; transition:all 0.2s;
}
.fab:active { transform:scale(0.88); }

/* ===== MODALS ===== */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.65);
  backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
  z-index:200; align-items:flex-end; justify-content:center;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--surface); border-radius:20px 20px 0 0;
  width:100%; max-width:480px;
  max-height:88vh; overflow-y:auto;
  padding:18px 20px 30px;
  animation:slideUp 0.28s ease-out;
}
@keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px);} to{opacity:1;transform:translateY(0);} }
.modal-handle { width:34px; height:4px; background:var(--border); border-radius:2px; margin:0 auto 14px; }
.modal h2 { font-size:1.2rem; font-weight:800; margin-bottom:18px; color:var(--accent); }

.field { margin-bottom:14px; }
.field label {
  display:block; font-size:0.75rem; font-weight:600;
  color:var(--text2); margin-bottom:5px;
  text-transform:uppercase; letter-spacing:0.5px;
}
.field input,.field select,.field textarea {
  width:100%; padding:11px 13px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:10px; color:var(--text);
  font-family:'DM Sans',sans-serif; font-size:0.92rem;
  outline:none; transition:border 0.2s;
}
.field input:focus,.field select:focus,.field textarea:focus { border-color:var(--accent); }
.field select { appearance:none; }
.field-row { display:flex; gap:9px; }
.field-row .field { flex:1; }
.modal-actions { display:flex; gap:9px; margin-top:18px; }
.modal-actions .action-btn { padding:13px; font-size:0.88rem; }

/* History */
.history-item {
  padding:9px 0; border-bottom:1px solid var(--border);
  font-size:0.85rem; display:flex; justify-content:space-between; align-items:center;
}
.history-item:last-child { border:none; }
.history-date { color:var(--text); font-weight:500; }
.history-ago { color:var(--text2); font-size:0.75rem; }
.history-who { color:var(--text3); font-size:0.72rem; font-style:italic; }

/* Empty */
.empty-state { text-align:center; padding:50px 36px; color:var(--text2); }
.empty-state .icon { font-size:2.8rem; margin-bottom:14px; opacity:0.35; }
.empty-state h3 { font-size:1.05rem; color:var(--text); margin-bottom:7px; }
.empty-state p { font-size:0.85rem; line-height:1.45; }

/* Settings */
.settings-section { padding:8px 0; }
.settings-section h3 { font-size:0.75rem; text-transform:uppercase; color:var(--text2); letter-spacing:0.5px; margin-bottom:10px; }
.settings-btn {
  width:100%; padding:13px 15px;
  background:var(--bg); border:1px solid var(--border);
  border-radius:10px; color:var(--text);
  font-family:'DM Sans',sans-serif; font-size:0.88rem;
  text-align:left; cursor:pointer; margin-bottom:7px;
  display:flex; justify-content:space-between; align-items:center;
  transition:all 0.15s;
}
.settings-btn:active { background:var(--surface2); }
.settings-btn .sub { color:var(--text2); font-size:0.78rem; }
.settings-btn.danger { color:var(--danger); }

/* Confirm */
.confirm-bar {
  display:none; position:fixed; bottom:0; left:0; right:0;
  background:var(--surface); border-top:1px solid var(--border);
  padding:16px 20px 28px; z-index:300; text-align:center;
}
.confirm-bar.open { display:block; }
.confirm-bar p { margin-bottom:12px; font-size:0.9rem; }

/* Sync indicator */
.sync-dot {
  width:7px; height:7px; border-radius:50%;
  background:var(--success); display:inline-block;
  margin-right:4px; vertical-align:middle;
  animation:pulse 2s infinite;
}
.sync-dot.offline { background:var(--danger); animation:none; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

.conn-status {
  font-size:0.7rem; color:var(--text3);
  display:flex; align-items:center; gap:3px;
  margin-top:6px;
}

/* Hide sections */
.hidden { display:none !important; }

@media(min-width:500px) {
  .modal { border-radius:20px; margin:auto; max-height:80vh; }
}
</style>
</head>
<body>

<!-- ===== SETUP SCREEN ===== -->
<div class="setup-screen" id="setupScreen">
  <div class="brand">HomeCare</div>
  <div class="sub">Shared home maintenance tracker</div>
  
  <div class="setup-box">
    <h3>Create a Household</h3>
    <p>Start a new shared tracker. You'll get a code to share with your partner.</p>
    <input type="text" class="setup-input" id="setupName" placeholder="Your name" style="letter-spacing:0;font-weight:500;text-transform:none;">
    <button class="setup-btn" onclick="createHousehold()">Create Household</button>
  </div>
  
  <div class="setup-divider">‚Äî or ‚Äî</div>
  
  <div class="setup-box">
    <h3>Join a Household</h3>
    <p>Enter the household code from your partner's app.</p>
    <input type="text" class="setup-input" id="joinName" placeholder="Your name" style="letter-spacing:0;font-weight:500;text-transform:none;margin-bottom:8px;">
    <input type="text" class="setup-input" id="joinCode" placeholder="XXXX" maxlength="6">
    <button class="setup-btn" onclick="joinHousehold()">Join Household</button>
  </div>
  
  <div class="setup-error" id="setupError"></div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="mainApp" class="hidden">
  <header class="header">
    <div class="header-top">
      <div>
        <div class="brand">HomeCare <span class="household-code" id="hCodeDisplay"></span></div>
        <div class="conn-status"><span class="sync-dot" id="syncDot"></span> <span id="syncLabel">Connected</span></div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="openSettings()" title="Settings">‚öô</button>
      </div>
    </div>
    <div class="stats-bar" id="statsBar"></div>
  </header>

  <div class="view-tabs">
    <button class="view-tab active" id="tabList" onclick="setView('list')">Tasks</button>
    <button class="view-tab" id="tabCal" onclick="setView('calendar')">Calendar</button>
  </div>

  <!-- LIST VIEW -->
  <div id="listView">
    <div class="filter-tabs" id="filterTabs"></div>
    <div class="task-list" id="taskList"></div>
  </div>

  <!-- CALENDAR VIEW -->
  <div id="calendarView" class="hidden">
    <div class="cal-controls" id="calControls">
      <button class="cal-range-btn active" onclick="setCalRange('today')">Today</button>
      <button class="cal-range-btn" onclick="setCalRange('week')">This Week</button>
      <button class="cal-range-btn" onclick="setCalRange('month')">This Month</button>
      <button class="cal-range-btn" onclick="setCalRange('all')">All Upcoming</button>
    </div>
    <div class="cal-section" id="calSection"></div>
  </div>

  <button class="fab" onclick="openAddModal()" title="Add task">+</button>
</div>

<!-- ===== MODALS ===== -->

<!-- Add/Edit Task -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modalTitle">Add Task</h2>
    <input type="hidden" id="editId">
    <div class="field">
      <label>Task Name</label>
      <input type="text" id="taskName" placeholder="e.g. Change air filter">
    </div>
    <div class="field">
      <label>Category</label>
      <select id="taskCategory">
        <option value="HVAC & Air">HVAC & Air</option>
        <option value="Water & Plumbing">Water & Plumbing</option>
        <option value="Auto">Auto</option>
        <option value="Appliances">Appliances</option>
        <option value="Cleaning">Cleaning</option>
        <option value="Seasonal">Seasonal</option>
        <option value="Exterior">Exterior</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="field-row">
      <div class="field">
        <label>Repeat Every</label>
        <input type="number" id="taskInterval" placeholder="3" min="1" value="3">
      </div>
      <div class="field">
        <label>Unit</label>
        <select id="taskUnit">
          <option value="days">Days</option>
          <option value="weeks">Weeks</option>
          <option value="months" selected>Months</option>
          <option value="years">Years</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>Last Completed</label>
      <div style="position:relative;">
        <input type="date" id="taskLastDone" style="appearance:none;-webkit-appearance:none;min-height:46px;padding-right:40px;">
        <span style="position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:1.1rem;pointer-events:none;">üìÖ</span>
      </div>
      <div style="margin-top:6px;display:flex;gap:6px;">
        <button type="button" onclick="setDateToday()" style="padding:5px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.78rem;cursor:pointer;">Today</button>
        <button type="button" onclick="setDateYesterday()" style="padding:5px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.78rem;cursor:pointer;">Yesterday</button>
        <button type="button" onclick="setDateLastWeek()" style="padding:5px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.78rem;cursor:pointer;">Last Week</button>
      </div>
    </div>
    <div class="field">
      <label>Notes (optional)</label>
      <textarea id="taskNotes" rows="2" placeholder="Filter size, product link, etc."></textarea>
    </div>
    <div class="modal-actions">
      <button class="action-btn" onclick="closeModal('taskModal')">Cancel</button>
      <button class="action-btn primary" onclick="saveTask()">Save</button>
    </div>
  </div>
</div>

<!-- History -->
<div class="modal-overlay" id="historyModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="historyTitle">History</h2>
    <div id="historyList"></div>
    <div class="modal-actions" style="margin-top:14px;">
      <button class="action-btn" onclick="closeModal('historyModal')">Close</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>Settings</h2>
    <div class="settings-section">
      <h3>Household</h3>
      <div style="padding:10px 0;font-size:0.88rem;">
        <div style="margin-bottom:6px;">Code: <strong id="settingsCode" style="color:var(--accent);letter-spacing:2px;"></strong></div>
        <div style="color:var(--text2);font-size:0.82rem;">Share this code so others can join your household.</div>
        <div style="margin-top:8px;">Logged in as: <strong id="settingsUser"></strong></div>
      </div>
    </div>
    <div class="settings-section">
      <h3>Tasks</h3>
      <button class="settings-btn" onclick="loadStarterTasks()">
        Load Starter Tasks <span class="sub">Common items</span>
      </button>
      <button class="settings-btn" onclick="exportData()">
        Export Backup <span class="sub">‚Üì JSON</span>
      </button>
      <button class="settings-btn" onclick="document.getElementById('importFile').click()">
        Import Backup <span class="sub">‚Üë JSON</span>
      </button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>
    <div class="settings-section">
      <h3>Account</h3>
      <button class="settings-btn danger" onclick="leaveHousehold()">Leave Household</button>
    </div>
    <div class="modal-actions" style="margin-top:6px;">
      <button class="action-btn" onclick="closeModal('settingsModal')">Close</button>
    </div>
  </div>
</div>

<!-- Confirm -->
<div class="confirm-bar" id="confirmBar">
  <p id="confirmMsg">Are you sure?</p>
  <div class="modal-actions">
    <button class="action-btn" onclick="closeConfirm()">Cancel</button>
    <button class="action-btn primary" id="confirmBtn">Confirm</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// ==========================================
// FIREBASE CONFIG ‚Äî YOU MUST REPLACE THIS
// ==========================================
// 1. Go to https://console.firebase.google.com
// 2. Create a new project (free)
// 3. Go to Realtime Database > Create Database (start in test mode)
// 4. Go to Project Settings > Your Apps > Add Web App
// 5. Copy the firebaseConfig object and paste below
// ==========================================

const firebaseConfig = {
  apiKey: "AIzaSyDvYp_TdwdfkkUSg9ium-cOlfP0GAFsl7s",
  authDomain: "home-maintenance-tracker-app.firebaseapp.com",
  databaseURL: "https://home-maintenance-tracker-app-default-rtdb.firebaseio.com",
  projectId: "home-maintenance-tracker-app",
  storageBucket: "home-maintenance-tracker-app.firebasestorage.app",
  messagingSenderId: "677573568299",
  appId: "1:677573568299:web:ec04023be43d3bbc80876e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== STATE =====
let householdId = null;
let userName = null;
let tasks = [];
let activeFilter = 'All';
let expandedTaskId = null;
let currentView = 'list';
let calRange = 'today';
let dbRef = null;
let isConnected = true;

// ===== LOCAL CONFIG =====
function getConfig() {
  try { return JSON.parse(localStorage.getItem('homecare_config')) || {}; } catch(e) { return {}; }
}
function saveConfig(cfg) {
  localStorage.setItem('homecare_config', JSON.stringify(cfg));
}

// ===== INIT =====
function init() {
  const cfg = getConfig();
  if (cfg.householdId && cfg.userName) {
    householdId = cfg.householdId;
    userName = cfg.userName;
    showApp();
    listenToData();
  } else {
    document.getElementById('setupScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }
  
  // Connection monitoring
  db.ref('.info/connected').on('value', (snap) => {
    isConnected = snap.val() === true;
    updateConnStatus();
  });
}

function updateConnStatus() {
  const dot = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  if (dot) {
    dot.className = isConnected ? 'sync-dot' : 'sync-dot offline';
    label.textContent = isConnected ? 'Synced' : 'Offline';
  }
}

// ===== HOUSEHOLD SETUP =====
function genHouseholdCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

async function createHousehold() {
  const name = document.getElementById('setupName').value.trim();
  if (!name) { showSetupError('Please enter your name'); return; }
  
  const code = genHouseholdCode();
  householdId = code;
  userName = name;
  
  try {
    await db.ref('households/' + code).set({
      created: Date.now(),
      members: { [sanitizeName(name)]: true }
    });
    
    saveConfig({ householdId: code, userName: name });
    showApp();
    listenToData();
  } catch(e) {
    showSetupError('Failed to create household. Check your internet connection.');
    console.error(e);
  }
}

async function joinHousehold() {
  const name = document.getElementById('joinName').value.trim();
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if (!name) { showSetupError('Please enter your name'); return; }
  if (!code || code.length < 4) { showSetupError('Please enter the household code'); return; }
  
  try {
    const snap = await db.ref('households/' + code).once('value');
    if (!snap.exists()) {
      showSetupError('Household not found. Check the code and try again.');
      return;
    }
    
    householdId = code;
    userName = name;
    
    await db.ref('households/' + code + '/members/' + sanitizeName(name)).set(true);
    
    saveConfig({ householdId: code, userName: name });
    showApp();
    listenToData();
  } catch(e) {
    showSetupError('Failed to join. Check your connection and try again.');
    console.error(e);
  }
}

function sanitizeName(n) { return n.replace(/[.#$[\]/]/g, '_'); }

function showSetupError(msg) {
  document.getElementById('setupError').textContent = msg;
  setTimeout(() => document.getElementById('setupError').textContent = '', 4000);
}

function showApp() {
  document.getElementById('setupScreen').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('hCodeDisplay').textContent = householdId;
}

function leaveHousehold() {
  if (confirm('Leave this household? You can rejoin with the code later.')) {
    if (dbRef) dbRef.off();
    localStorage.removeItem('homecare_config');
    householdId = null;
    userName = null;
    tasks = [];
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('setupScreen').classList.remove('hidden');
    closeModal('settingsModal');
  }
}

// ===== FIREBASE DATA =====
function listenToData() {
  dbRef = db.ref('households/' + householdId + '/tasks');
  dbRef.on('value', (snap) => {
    const data = snap.val();
    if (data) {
      tasks = Object.keys(data).map(k => ({ id: k, ...data[k] }));
    } else {
      tasks = [];
    }
    render();
  });
}

function pushTask(taskData) {
  const ref = db.ref('households/' + householdId + '/tasks').push();
  return ref.set(taskData).then(() => ref.key);
}

function updateTask(id, data) {
  return db.ref('households/' + householdId + '/tasks/' + id).update(data);
}

function removeTask(id) {
  return db.ref('households/' + householdId + '/tasks/' + id).remove();
}

// ===== DATE HELPERS =====
// CRITICAL: parse "YYYY-MM-DD" as local midnight, not UTC
function parseLocalDate(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split('-');
  if (parts.length === 3) {
    return new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
  }
  // Fallback: force local interpretation by replacing hyphens
  return new Date(dateStr.replace(/-/g, '/'));
}

function addInterval(date, interval, unit) {
  const d = parseLocalDate(date) || new Date(date);
  switch(unit) {
    case 'days': d.setDate(d.getDate()+interval); break;
    case 'weeks': d.setDate(d.getDate()+interval*7); break;
    case 'months': d.setMonth(d.getMonth()+interval); break;
    case 'years': d.setFullYear(d.getFullYear()+interval); break;
  }
  return d;
}
function getDueDate(task) {
  if (!task.lastDone) return new Date(0);
  return addInterval(task.lastDone, task.interval, task.unit);
}
function getDaysUntilDue(task) {
  const due = getDueDate(task);
  const now = new Date(); now.setHours(0,0,0,0);
  return Math.ceil((due - now) / (1000*60*60*24));
}
function getStatus(task) {
  if (!task.lastDone) return 'overdue';
  const days = getDaysUntilDue(task);
  if (days < 0) return 'overdue';
  if (days <= 7) return 'due-soon';
  return 'good';
}
function formatDate(dateInput) {
  if (!dateInput) return 'Never';
  const d = (dateInput instanceof Date) ? dateInput : parseLocalDate(dateInput);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const d = parseLocalDate(dateStr); d.setHours(0,0,0,0);
  const now = new Date(); now.setHours(0,0,0,0);
  const diff = Math.round((now - d) / (1000*60*60*24));
  if (diff===0) return 'Today';
  if (diff===1) return 'Yesterday';
  if (diff<30) return diff+' days ago';
  if (diff<60) return '1 month ago';
  if (diff<365) return Math.floor(diff/30)+' months ago';
  return Math.floor(diff/365)+'y ago';
}
function formatInterval(interval, unit) {
  return interval===1 ? `Every ${unit.slice(0,-1)}` : `Every ${interval} ${unit}`;
}
function formatDayHeader(date) {
  const today = new Date(); today.setHours(0,0,0,0);
  const d = parseLocalDate(date) || new Date(date); d.setHours(0,0,0,0);
  const diff = Math.round((d-today)/(1000*60*60*24));
  const dayName = d.toLocaleDateString('en-US',{weekday:'long'});
  const dateStr = d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if (diff===0) return { label:'Today', sub:dayName+', '+dateStr, isToday:true };
  if (diff===1) return { label:'Tomorrow', sub:dayName+', '+dateStr, isToday:false };
  if (diff===-1) return { label:'Yesterday', sub:dayName+', '+dateStr, isToday:false };
  return { label:dayName, sub:dateStr, isToday:false };
}
function esc(s) { if(!s)return''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// ===== VIEWS =====
function setView(v) {
  currentView = v;
  document.getElementById('tabList').classList.toggle('active', v==='list');
  document.getElementById('tabCal').classList.toggle('active', v==='calendar');
  document.getElementById('listView').classList.toggle('hidden', v!=='list');
  document.getElementById('calendarView').classList.toggle('hidden', v!=='calendar');
  if (v==='calendar') renderCalendar();
}

function setCalRange(r) {
  calRange = r;
  document.querySelectorAll('.cal-range-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(
    r==='today'?'today':r==='week'?'week':r==='month'?'month':'all'
  )));
  renderCalendar();
}

// ===== RENDER =====
function getCategories() {
  return ['All', ...Array.from(new Set(tasks.map(t=>t.category))).sort()];
}

function renderStats() {
  const c = {overdue:0,'due-soon':0,good:0};
  tasks.forEach(t => c[getStatus(t)]++);
  document.getElementById('statsBar').innerHTML = `
    ${c.overdue?`<div class="stat-pill stat-overdue"><span class="dot"></span>${c.overdue} Overdue</div>`:''}
    ${c['due-soon']?`<div class="stat-pill stat-due"><span class="dot"></span>${c['due-soon']} Due Soon</div>`:''}
    <div class="stat-pill stat-good"><span class="dot"></span>${c.good} On Track</div>
    <div class="stat-pill" style="background:var(--surface);color:var(--text2);">${tasks.length} Total</div>
  `;
}

function renderFilters() {
  document.getElementById('filterTabs').innerHTML = getCategories().map(c =>
    `<button class="tab ${c===activeFilter?'active':''}" onclick="setFilter('${esc(c)}')">${esc(c)}</button>`
  ).join('');
}

function renderTasks() {
  const filtered = activeFilter==='All' ? [...tasks] : tasks.filter(t=>t.category===activeFilter);
  if (!filtered.length) {
    document.getElementById('taskList').innerHTML = `
      <div class="empty-state">
        <div class="icon">üè†</div>
        <h3>${tasks.length===0?'No tasks yet':'No tasks here'}</h3>
        <p>${tasks.length===0?'Tap + to add your first task, or load starter tasks from Settings.':'Try a different filter.'}</p>
      </div>`;
    return;
  }
  const statusOrder = {'overdue':0,'due-soon':1,'good':2};
  filtered.sort((a,b) => {
    const sa=statusOrder[getStatus(a)], sb=statusOrder[getStatus(b)];
    if(sa!==sb) return sa-sb;
    return getDaysUntilDue(a)-getDaysUntilDue(b);
  });

  let html = '';
  filtered.forEach(task => {
    const status = getStatus(task);
    const days = getDaysUntilDue(task);
    const expanded = task.id===expandedTaskId;
    let badgeText, badgeClass;
    if (status==='overdue') {
      badgeText = task.lastDone ? (Math.abs(days)===1?'1d overdue':`${Math.abs(days)}d overdue`) : 'Never done';
      badgeClass = 'badge-overdue';
    } else if (status==='due-soon') {
      badgeText = days===0?'Due today':days===1?'Due tomorrow':`Due in ${days}d`;
      badgeClass = 'badge-due';
    } else {
      badgeText = `${days}d left`;
      badgeClass = 'badge-good';
    }
    html += `
      <div class="task-card ${status}" onclick="toggleExpand('${task.id}')">
        <div class="task-top">
          <div class="task-name">${esc(task.name)}</div>
          <div class="task-badge ${badgeClass}">${badgeText}</div>
        </div>
        <div class="task-meta">
          <span>‚ü≥ ${formatInterval(task.interval,task.unit)}</span>
          <span>‚úì ${task.lastDone?timeAgo(task.lastDone):'Never'}</span>
          ${task.notes?'<span>üìù</span>':''}
        </div>
        ${expanded?`
          <div class="task-meta" style="margin-top:5px;">
            <span>üìÅ ${esc(task.category)}</span>
            <span>üìÖ Due: ${formatDate(getDueDate(task))}</span>
          </div>
          ${task.notes?`<div style="margin-top:9px;padding:9px;background:var(--bg);border-radius:8px;font-size:0.82rem;color:var(--text2);">${esc(task.notes)}</div>`:''}
          <div class="task-actions" onclick="event.stopPropagation()">
            <button class="action-btn primary" onclick="markDone('${task.id}')">‚úì Done</button>
            <button class="action-btn" onclick="showHistory('${task.id}')">History</button>
            <button class="action-btn" onclick="editTask('${task.id}')">Edit</button>
            <button class="action-btn" onclick="confirmDelete('${task.id}')" style="color:var(--danger)">‚úï</button>
          </div>
        `:''}
      </div>`;
  });
  document.getElementById('taskList').innerHTML = html;
}

function renderCalendar() {
  const now = new Date(); now.setHours(0,0,0,0);
  const todayEnd = new Date(now); todayEnd.setDate(todayEnd.getDate()+1);
  
  const weekStart = new Date(now); weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate()+7);
  
  const monthStart = new Date(now); monthStart.setDate(1);
  const monthEnd = new Date(monthStart); monthEnd.setMonth(monthEnd.getMonth()+1);

  // Group ALL tasks by due date or 'overdue' bucket
  const dayMap = {};
  const overdueTasks = [];
  const futureTasks = [];

  tasks.forEach(task => {
    const due = getDueDate(task);
    due.setHours(0,0,0,0);
    const isOverdue = due < now;
    const neverDone = !task.lastDone;

    if (isOverdue || neverDone) {
      overdueTasks.push(task);
    } else {
      futureTasks.push(task);
    }
  });

  // Filter future tasks based on range
  let filteredFuture = [];
  if (calRange === 'today') {
    filteredFuture = futureTasks.filter(t => { const d=getDueDate(t); d.setHours(0,0,0,0); return d.getTime()===now.getTime(); });
  } else if (calRange === 'week') {
    filteredFuture = futureTasks.filter(t => { const d=getDueDate(t); d.setHours(0,0,0,0); return d>=weekStart && d<weekEnd; });
  } else if (calRange === 'month') {
    filteredFuture = futureTasks.filter(t => { const d=getDueDate(t); d.setHours(0,0,0,0); return d>=monthStart && d<monthEnd; });
  } else {
    filteredFuture = [...futureTasks]; // all
  }

  // Always show overdue tasks regardless of range
  if (overdueTasks.length) {
    dayMap['overdue'] = overdueTasks;
  }

  // Group future tasks by date ‚Äî use local date string, NOT toISOString (which is UTC)
  filteredFuture.forEach(task => {
    const due = getDueDate(task);
    const key = `${due.getFullYear()}-${String(due.getMonth()+1).padStart(2,'0')}-${String(due.getDate()).padStart(2,'0')}`;
    if (!dayMap[key]) dayMap[key] = [];
    dayMap[key].push(task);
  });

  const sortedKeys = Object.keys(dayMap).sort((a,b) => {
    if (a==='overdue') return -1;
    if (b==='overdue') return 1;
    return a.localeCompare(b);
  });

  if (!sortedKeys.length) {
    document.getElementById('calSection').innerHTML = `
      <div class="cal-empty">
        ${calRange==='today' ? 'Nothing due or overdue today! üéâ' :
          calRange==='week' ? 'Nothing due this week and nothing overdue!' :
          calRange==='month' ? 'Nothing due this month and nothing overdue!' :
          'No tasks yet. Add some to get started.'}
      </div>`;
    return;
  }

  let html = '';
  sortedKeys.forEach(key => {
    let header;
    if (key==='overdue') {
      header = { label:'Overdue', sub:`${dayMap[key].length} task${dayMap[key].length>1?'s':''} need attention`, isToday:false };
    } else {
      header = formatDayHeader(key);
    }
    html += `<div class="cal-day-header ${header.isToday?'today':''} ${key==='overdue'?'overdue':''}">
      <span class="day-label" ${key==='overdue'?'style="color:var(--danger)"':''}>${header.label}</span>
      <span class="day-sub">${header.sub}</span>
    </div>`;
    
    const sorted = dayMap[key].sort((a,b) => getDaysUntilDue(a)-getDaysUntilDue(b));
    sorted.forEach(task => {
      const status = getStatus(task);
      const days = getDaysUntilDue(task);
      const dueInfo = status==='overdue' ? (task.lastDone ? `${Math.abs(days)}d overdue` : 'Never done') : `in ${days}d`;
      html += `
        <div class="cal-task" onclick="toggleExpand('${task.id}');setView('list');">
          <span class="cal-task-dot ${status}"></span>
          <div style="flex:1;min-width:0;">
            <span class="cal-task-name">${esc(task.name)}</span>
            <div style="font-size:0.72rem;color:var(--text3);margin-top:2px;">${esc(task.category)} ¬∑ ${dueInfo}</div>
          </div>
          <button class="cal-task-action" onclick="event.stopPropagation();markDone('${task.id}')">Done</button>
        </div>`;
    });
  });

  document.getElementById('calSection').innerHTML = html;
}

function render() {
  renderStats();
  renderFilters();
  renderTasks();
  if (currentView==='calendar') renderCalendar();
  document.getElementById('settingsCode').textContent = householdId;
  document.getElementById('settingsUser').textContent = userName;
}

// ===== INTERACTIONS =====
function setFilter(cat) { activeFilter=cat; expandedTaskId=null; render(); }
function toggleExpand(id) { expandedTaskId = expandedTaskId===id?null:id; renderTasks(); }

function markDone(id) {
  const task = tasks.find(t=>t.id===id);
  if (!task) return;
  const now = new Date().toISOString().split('T')[0];
  const history = task.history || [];
  history.unshift({ date:now, by:userName });
  updateTask(id, { lastDone:now, history });
}

// ===== MODALS =====
function openAddModal() {
  document.getElementById('editId').value = '';
  document.getElementById('modalTitle').textContent = 'Add Task';
  document.getElementById('taskName').value = '';
  document.getElementById('taskCategory').value = 'HVAC & Air';
  document.getElementById('taskInterval').value = '3';
  document.getElementById('taskUnit').value = 'months';
  document.getElementById('taskLastDone').value = '';
  document.getElementById('taskNotes').value = '';
  openModal('taskModal');
}

function editTask(id) {
  const task = tasks.find(t=>t.id===id);
  if (!task) return;
  document.getElementById('editId').value = id;
  document.getElementById('modalTitle').textContent = 'Edit Task';
  document.getElementById('taskName').value = task.name;
  document.getElementById('taskCategory').value = task.category;
  document.getElementById('taskInterval').value = task.interval;
  document.getElementById('taskUnit').value = task.unit;
  document.getElementById('taskLastDone').value = task.lastDone||'';
  document.getElementById('taskNotes').value = task.notes||'';
  openModal('taskModal');
}

function saveTask() {
  const name = document.getElementById('taskName').value.trim();
  if (!name) { document.getElementById('taskName').focus(); return; }
  const editId = document.getElementById('editId').value;
  const data = {
    name,
    category: document.getElementById('taskCategory').value,
    interval: parseInt(document.getElementById('taskInterval').value)||1,
    unit: document.getElementById('taskUnit').value,
    lastDone: document.getElementById('taskLastDone').value||null,
    notes: document.getElementById('taskNotes').value.trim(),
  };
  if (editId) {
    updateTask(editId, data);
  } else {
    const lastDone = data.lastDone;
    pushTask({ ...data, history: lastDone ? [{ date:lastDone, by:userName }] : [] });
  }
  closeModal('taskModal');
  expandedTaskId=null;
}

function showHistory(id) {
  const task = tasks.find(t=>t.id===id);
  if (!task) return;
  document.getElementById('historyTitle').textContent = task.name;
  const history = task.history || [];
  const list = history.length
    ? history.map(h => {
        const entry = typeof h==='string' ? {date:h, by:'‚Äî'} : h;
        return `<div class="history-item">
          <div>
            <span class="history-date">${formatDate(entry.date)}</span>
            <span class="history-who"> ‚Äî ${esc(entry.by)}</span>
          </div>
          <span class="history-ago">${timeAgo(entry.date)}</span>
        </div>`;
      }).join('')
    : '<p style="color:var(--text2);padding:20px 0;text-align:center;">No history yet.</p>';
  document.getElementById('historyList').innerHTML = list;
  openModal('historyModal');
}

// ===== SETTINGS =====
function openSettings() { openModal('settingsModal'); }

function exportData() {
  const blob = new Blob([JSON.stringify(tasks,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `homecare-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        for (const t of imported) {
          const {id, ...data} = t;
          await pushTask(data);
        }
        closeModal('settingsModal');
        alert('Imported '+imported.length+' tasks!');
      }
    } catch(err) { alert('Invalid file'); }
  };
  reader.readAsText(file);
  event.target.value='';
}

function loadStarterTasks() {
  const starters = [
    {name:'Change HVAC air filter',category:'HVAC & Air',interval:3,unit:'months',notes:'Check filter size on side of current filter'},
    {name:'Replace water filter',category:'Water & Plumbing',interval:6,unit:'months',notes:''},
    {name:'Change car oil',category:'Auto',interval:6,unit:'months',notes:'Or every 5,000 miles'},
    {name:'Rotate car tires',category:'Auto',interval:6,unit:'months',notes:'Or every 5,000-7,500 miles'},
    {name:'Winterize outdoor spigots',category:'Seasonal',interval:1,unit:'years',notes:'Disconnect hoses, install covers before first freeze'},
    {name:'De-winterize spigots',category:'Seasonal',interval:1,unit:'years',notes:'Remove covers, check for leaks in spring'},
    {name:'Clean refrigerator coils',category:'Appliances',interval:6,unit:'months',notes:'Behind or underneath fridge'},
    {name:'Deep clean oven',category:'Appliances',interval:3,unit:'months',notes:''},
    {name:'Clean dishwasher',category:'Appliances',interval:1,unit:'months',notes:'Run empty cycle with vinegar or cleaner'},
    {name:'Clean washing machine',category:'Appliances',interval:1,unit:'months',notes:'Run cleaning cycle'},
    {name:'Replace smoke detector batteries',category:'Other',interval:1,unit:'years',notes:'Test detectors monthly'},
    {name:'Clean dryer vent',category:'Appliances',interval:1,unit:'years',notes:'Prevents fire hazard'},
    {name:'Deep clean bathrooms',category:'Cleaning',interval:2,unit:'weeks',notes:''},
    {name:'Deep clean kitchen',category:'Cleaning',interval:1,unit:'weeks',notes:''},
    {name:'Clean gutters',category:'Exterior',interval:6,unit:'months',notes:'Spring and fall'},
    {name:'Check water heater',category:'Water & Plumbing',interval:1,unit:'years',notes:'Flush sediment, check anode rod'},
    {name:'HVAC service / tune-up',category:'HVAC & Air',interval:1,unit:'years',notes:'Schedule before summer or winter'},
    {name:'Replace cabin air filter',category:'Auto',interval:1,unit:'years',notes:'Usually behind glove box'},
  ];
  const existing = new Set(tasks.map(t=>t.name.toLowerCase()));
  let added = 0;
  starters.forEach(s => {
    if (!existing.has(s.name.toLowerCase())) {
      pushTask({...s, lastDone:null, history:[]});
      added++;
    }
  });
  closeModal('settingsModal');
  setTimeout(()=>alert(`Added ${added} starter tasks!`), 300);
}

function confirmDelete(id) {
  const task = tasks.find(t=>t.id===id);
  if (!task) return;
  showConfirm(`Delete "${task.name}"?`, ()=>{
    removeTask(id);
    expandedTaskId=null;
  });
}

// ===== MODAL HELPERS =====
function toLocalDateStr(d) { return d.toISOString().split('T')[0]; }
function setDateToday() { document.getElementById('taskLastDone').value = toLocalDateStr(new Date()); }
function setDateYesterday() { const d=new Date(); d.setDate(d.getDate()-1); document.getElementById('taskLastDone').value=toLocalDateStr(d); }
function setDateLastWeek() { const d=new Date(); d.setDate(d.getDate()-7); document.getElementById('taskLastDone').value=toLocalDateStr(d); }

function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if(e.target===el) closeModal(el.id); });
});

let confirmCallback = null;
function showConfirm(msg, cb) {
  document.getElementById('confirmMsg').textContent = msg;
  confirmCallback = cb;
  document.getElementById('confirmBar').classList.add('open');
  document.getElementById('confirmBtn').onclick = () => { closeConfirm(); if(confirmCallback) confirmCallback(); };
}
function closeConfirm() { document.getElementById('confirmBar').classList.remove('open'); confirmCallback=null; }

// ===== GO =====
init();
</script>
</body>
</html>
